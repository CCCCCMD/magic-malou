<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MQTTæ¶ˆæ¯å‘é€</title>
    <script src="./mqtt.min.js"></script>
    <link rel="stylesheet" type="text/css" href="style.css">
</head>

<body>
    <div class="container">
        <h2 class="title">å—å–½ç•™è¨€æ¿</h2>
        <h3 class="subTitle">ğŸ’ å’±ä»¬222ä¸ªçŒ´æŠŠæ—¥å­è¿‡å¥½æ¯”ä»€ä¹ˆéƒ½é‡è¦ ğŸ’</h3>
        <div class="formContainer">
            <div class="inputContainer">
                <label class="formLabel" for="sender">ğŸµ ä½ æ˜¯å“ªä¸ªçŒ´</label>

                <input class="formInput" type="text" id="sender" placeholder="çŒ´å">
            </div>

            <div class="inputContainer">
                <label class="formLabel" for="message">ğŸ™ˆ æ¶ˆæ¯</label>
                <input class="formInput" type="text" id="message" placeholder="è¾“å…¥æ¶ˆæ¯">
            </div>

            <button class="submitButton" onclick="sendMessage()">ğŸŒ å‘é€ ğŸŒ</button>
        </div>


        <div id="messageBox"></div>

        <script>
            const randomClientId = 'client_' + Math.random().toString(36).substr(2, 9);

            const options = {
                clean: true,
                connectTimeout: 4000,
                clientId: randomClientId,
                username: '$SECRET_UI_MQTT_USERNAME',
                password: '$SECRET_UI_MQTT_PASSWORD'
            }

            const connectUrl = '$SECRET_UI_MQTT_URL'
            const client = mqtt.connect(connectUrl, options)

            client.on('reconnect', (error) => {
                console.log('æ­£åœ¨é‡è¿:', error)
            })

            client.on('error', (error) => {
                console.log('è¿æ¥å¤±è´¥:', error)
            })

            client.on('message', (topic, message) => {
                console.log('æ”¶åˆ°æ¶ˆæ¯ï¼š', topic, message.toString())
                displayMessage(topic, message.toString())
            })

            function sendMessage() {
                const sender = document.getElementById('sender').value;
                const message = document.getElementById('message').value;

                if (sender && message) {
                    const topic = `malou/${sender}`;
                    client.publish(topic, message);
                    displayMessage(sender, message);
                } else {
                    alert('è¯·è¾“å…¥å‘é€äººå’Œæ¶ˆæ¯');
                }
            }

            function displayMessage(sender, message) {
                const messageBox = document.getElementById('messageBox');
                const newMessage = document.createElement('p');
                newMessage.textContent = `${sender}: ${message}`;
                messageBox.appendChild(newMessage);
                // æ»šåŠ¨åˆ°åº•éƒ¨
                messageBox.scrollTop = messageBox.scrollHeight;
            }
        </script>
    </div>
</body>

</html>